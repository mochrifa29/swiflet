<div class="p-6 max-w-3xl mx-auto">

  <!-- Tombol Kembali -->
  <a href="/stok"
     class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 hover:text-blue-600 mb-5">
    <i data-lucide="arrow-left" class="w-5 h-5"></i>
    Kembali
  </a>

  <!-- Wrapper 2 kolom -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">

      <!-- ======================================= -->
      <!-- Card Detail -->
      <!-- ======================================= -->
      <div class="bg-white shadow-md rounded-xl p-6 border border-gray-200 h-full flex flex-col">

        <h1 class="text-2xl font-semibold mb-5 text-gray-800">Detail Stok Barang</h1>

        <div class="space-y-2 text-sm flex-1 mt-3">

          <!-- Nama Barang -->
          <div class="flex justify-between">
            <span class="text-gray-600">Nama Barang:</span>
            <span class="font-semibold text-gray-800"><%= stok.barang.nama_barang %></span>
          </div>

          <!-- Grade -->
          <div class="flex justify-between">
            <span class="text-gray-600">Grade:</span>
            <span class="font-semibold text-gray-800"><%= stok.barang.grade %></span>
          </div>

          <!-- Berat -->
          <div class="flex justify-between">
            <span class="text-gray-600">Berat:</span>
            <span class="font-semibold text-gray-800"><%= stok.berat %> gram</span>
          </div>

          <!-- Ready -->
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Status Ready:</span>

            <% if (stok.ready) { %>
              <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">
                READY
              </span>
            <% } else { %>
              <span class="px-3 py-1 rounded-full bg-red-200 text-red-800 text-xs font-bold">
                NOT READY
              </span>
            <% } %>

          </div>

          <!-- Tanggal Input -->
          <div class="flex justify-between">
            <span class="text-gray-600">Tanggal Input:</span>
            <span class="font-semibold text-gray-800">
              <%= stok.createdAt.toLocaleDateString("id-ID", {
                day:"numeric", month:"long", year:"numeric"
              }) %>
            </span>
          </div>

        </div>
        
        <div x-data="uploadVideo" class="space-y-3">

  <div>
    <label class="block font-medium text-gray-700 mb-1">Pilih Video</label>
    <input type="file" accept="video/mp4"
           @change="file = $event.target.files[0]"
           class="w-full border border-gray-300 p-2 rounded-lg">
  </div>

 

  <button @click="upload" 
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow flex items-center gap-2"
        :class="uploading ? 'opacity-70 cursor-not-allowed' : ''"
        :disabled="uploading">

    <svg x-show="uploading"
         class="w-5 h-5 animate-spin text-white"
         fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" 
              stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>

    <span x-show="!uploading">Upload</span>
    <span x-show="uploading">Mengupload...</span>
</button>


  <div x-text="message" class="text-sm font-semibold mt-2"></div>

</div>


      </div>


      <!-- ======================================= -->
      <!-- Card Video -->
      <!-- ======================================= -->
      <div class="bg-white shadow-md rounded-xl p-6 border border-gray-200 h-full flex flex-col">

        <% if (typeof error !== "undefined" && error) { %>
          <div class="mb-4 mt-2 p-3 rounded text-sm font-semibold" 
              style="background-color:#fee2e2; color:#b91c1c;">
            <%= error %>
          </div>
        <% } else if (typeof success !== "undefined" && success) { %>
          <div class="mb-4 mt-2 p-3 rounded text-sm font-semibold" 
              style="background-color:#d1fae5; color:#065f46;">
            <%= success %>
          </div>
        <% } %>


        <!-- Header: Judul + Tombol Hapus -->
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-xl font-semibold text-gray-800">Video Barang</h2>

        <% if (stok.video_url && stok.video_url !== "") { %>
          <form action="/stok/delete-video/<%= stok._id %>" method="POST" 
                onsubmit="return confirm('Yakin ingin menghapus video ini?')">
            <button type="submit"
                    class="flex items-center gap-2 px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
              Hapus
            </button>
          </form>
        <% } %>
      </div>

        <div class="flex-1 flex items-center justify-center mt-5">
          <% if (stok.video_url && stok.video_url !== "") { %>

            <div class="w-64 h-80 mx-auto bg-black rounded-lg overflow-hidden flex items-center justify-center">
              <video controls class="w-full h-full object-contain">
                <source src="<%= stok.video_url %>" type="video/mp4">
              </video>
            </div>

            

          <% } else { %>

            <!-- Jika tidak ada video -->
            <div class="text-center text-gray-500 italic">
              Tidak ada video untuk barang ini.
            </div>

          <% } %>
        </div>

      </div>

    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  lucide.createIcons();

  document.addEventListener("alpine:init", () => {
    Alpine.data("uploadVideo", () => ({
      file: null,
      uploading: false,
      message: "",

      async upload() {
        if (!this.file) {
          this.message = "Pilih video terlebih dahulu.";
          return;
        }

        this.uploading = true;
        this.message = "";
        this.progress = 0;

        const supabase = window.supabase.createClient(
            "<%= SUPABASE_URL %>",
            "<%= SUPABASE_ANON_KEY %>"
        );

        const fileName = Date.now() + "-" + this.file.name;
        const filePath = "stok/" + fileName;

        // Upload dengan progress listener
        const { data, error } = await supabase.storage
          .from("videos")
          .upload(filePath, this.file, {
            upsert: false,
          });

        if (error) {
          this.message = "Upload gagal: " + error.message;
          this.uploading = false;
          return;
        }

        // Ambil public URL
        const { data: urlData } = supabase.storage
          .from("videos")
          .getPublicUrl(filePath);

        // Kirim ke backend
        await fetch("/stok/upload-video/<%= stok._id %>", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            video_url: urlData.publicUrl,
            video_path: filePath
          })
        });

        window.location.reload();
      }
    }));
  });
</script>

